<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Svensk Fågeltaxering</title>

<script src="site_libs/header-attrs-2.16/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/clipboard-1.7.1/clipboard.min.js"></script>
<link href="site_libs/primer-tooltips-1.4.0/build.css" rel="stylesheet" />
<link href="site_libs/klippy-0.0.0.9500/css/klippy.min.css" rel="stylesheet" />
<script src="site_libs/klippy-0.0.0.9500/js/klippy.min.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  { color: #cccccc; background-color: #303030; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffcfaf; } /* Alert */
code span.an { color: #7f9f7f; font-weight: bold; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #dca3a3; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #f0dfaf; } /* ControlFlow */
code span.ch { color: #dca3a3; } /* Char */
code span.cn { color: #dca3a3; font-weight: bold; } /* Constant */
code span.co { color: #7f9f7f; } /* Comment */
code span.cv { color: #7f9f7f; font-weight: bold; } /* CommentVar */
code span.do { color: #7f9f7f; } /* Documentation */
code span.dt { color: #dfdfbf; } /* DataType */
code span.dv { color: #dcdccc; } /* DecVal */
code span.er { color: #c3bf9f; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #c0bed1; } /* Float */
code span.fu { color: #efef8f; } /* Function */
code span.im { } /* Import */
code span.in { color: #7f9f7f; font-weight: bold; } /* Information */
code span.kw { color: #f0dfaf; } /* Keyword */
code span.op { color: #f0efd0; } /* Operator */
code span.ot { color: #efef8f; } /* Other */
code span.pp { color: #ffcfaf; font-weight: bold; } /* Preprocessor */
code span.sc { color: #dca3a3; } /* SpecialChar */
code span.ss { color: #cc9393; } /* SpecialString */
code span.st { color: #cc9393; } /* String */
code span.va { } /* Variable */
code span.vs { color: #cc9393; } /* VerbatimString */
code span.wa { color: #7f9f7f; font-weight: bold; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Ecological Methods</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Exercises
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="./Bird_survey.html">1. Svensk Fågeltaxering</a>
    </li>
    <li>
      <a href="./Trends.html">2. Indices for Farmland and Forest Birds</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">




</div>


<script>
  addClassKlippyTo("pre.r, pre.markdown");
  addKlippy('right', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>This exercise is designed to familiarize you with the data from <em>The Swedish Bird Inventory (Svensk Fågeltaxering)</em>. On <a href="https://www.fageltaxering.lu.se/">this</a> website, you can read more about the data set (field protocol, history, etc.). A second aim is to continue improving your R-skills.</p>
</div>
<div id="getting-started" class="section level2">
<h2>Getting started</h2>
<div id="working-directory-project-folders-and-reading-data" class="section level3">
<h3>Working directory, Project folders, and Reading data</h3>
<ul>
<li>Remember that your working directory is usually the folder where your R script or R project is kept.</li>
<li>If you place the data for today’s exercise in the same folder as the project you created for the exercises in this class, you can simply continue working in that project and the data should be available.</li>
<li>If you are unfamiliar with R-projects <a href="https://clausrueffler.github.io/CodingWithR/Projects.html">this website</a> is a starting point to learn more.</li>
</ul>
</div>
<div id="download-bird-data-for-this-exercise-and-read-them-into-r" class="section level3">
<h3>Download bird data for this exercise and read them into R</h3>
<p>You can download the data for this exercise <a href="https://clausrueffler.github.io/svensk-fageltaxering/downloads/bird_data_subset2023.csv">here</a>. Alternatively, you can download the data as an R-data file <a href="https://clausrueffler.github.io/svensk-fageltaxering/downloads/bird_data_subset2023.RDA">here</a>.</p>
<p>The data set that you can download here is a reduced version of the full data set, which is available <a href="https://www.gbif.org/dataset/91fa1a0d-a208-40aa-8a6e-f2c0beb9b253">from the GBIF website</a>.</p>
<p>Move the downloaded <em>.csv</em> file into your project folder (working directory) and then read the data into R:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>birds <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;bird_data_subset2023.csv&quot;</span>, <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># or</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>birds <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;bird_data_subset2023.RDA&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="trends-of-farmland-and-forest-bird-species" class="section level2">
<h2>Trends of farmland and forest bird species</h2>
<div id="background" class="section level3">
<h3>Background</h3>
<p>Below, you can find two lists of ten common bird species associated with farmlands and forest habitats, respectively. The data set we are working with has been reduced to include only the following twenty species and only a few columns with the most relevant information. <em>Click on the names to get more information on the species and to see some nice pictures!</em></p>
<div id="farmland-birds" class="section level4">
<h4>Farmland birds:</h4>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Common_kestrel">Common Kestrel (<em>Falco tinnunculus</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Northern_lapwing">Northern Lapwing (<em>Vanellus vanellus</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Eurasian_skylark">Skylark (<em>Alauda arvensis</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Whinchat">Whinchat (<em>Saxicola rubetra</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Meadow_pipit">Meadow pipit (<em>Anthus pratensis</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Western_yellow_wagtail">Yellow wagtail (<em>Motacilla flava</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Yellowhammer">Yellowhammer (<em>Emberiza citrinella</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Eurasian_tree_sparrow">Tree sparrow (<em>Passer montanus</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Common_starling">Starling (<em>Sturnus vulgaris</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Common_whitethroat">Common whitethroat (<em>Sylvia communis</em>)</a></li>
</ul>
</div>
<div id="forest-birds" class="section level4">
<h4>Forest birds:</h4>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Eurasian_sparrowhawk">Eurasian sparrowhawk (<em>Accipiter nisus</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Eurasian_jay">Euroasian jay (<em>Garrulus glandarius</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Great_spotted_woodpecker">Greater spotted woodpecker (<em>Dendrocopos major</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Coal_tit">Coal tit (<em>Periparus ater</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Common_redstart">Common redstart (<em>Phoenicurus phoenicurus</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Common_chiffchaff">Common chiffchaff (<em>Phylloscopus collybita</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Tree_pipit">Tree pipit (<em>Anthus trivialis</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Eurasian_siskin">Siskin (<em>Spinus spinus</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Hawfinch">Hawfinch (<em>Coccothraustes coccothraustes</em>)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Eurasian_bullfinch">Bullfinch (<em>Pyrrhula pyrrhula</em>)</a></li>
</ul>
</div>
</div>
<div id="exploring-the-data" class="section level3">
<h3>Exploring the data</h3>
<p>Let’s start by looking at a quick summary of the data set in order to get a feel for its content and structure.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dimension of the data frame birds</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(birds)</span></code></pre></div>
<pre><code>## [1] 74176     7</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first three rows of the data frame birds</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(birds, <span class="dv">3</span> )</span></code></pre></div>
<pre><code>##   year             species organismQuantity decimalLongitude decimalLatitude
## 2 1998     Alauda arvensis                4          11.3098         58.4315
## 3 1998    Anthus pratensis                3          11.3098         58.4315
## 5 1998 Emberiza citrinella               10          11.3098         58.4315
##   LocationID habitat
## 2          3   Farms
## 3          3   Farms
## 5          3   Farms</code></pre>
<p>In this data set, each row (or, each <em>observation</em>) represents the count of a species in a given year on a given survey route. The first row, for example, says that there was 21 individual of <em>Accipiter nisus</em> (Sparrowhawk) observed in route number 3 during the year 1998. Here’s a description of the columns:</p>
<ul>
<li><em>year</em> gives the year of the observation</li>
<li><em>species</em> gives the species observed</li>
<li><em>organismQuantity</em> gives the number of individuals observed</li>
<li><em>decimalLongitude</em> and <em>decimalLatitude</em> give the geographic coordinates for each route (in WGS84).</li>
<li><em>LocationID</em> gives the route number</li>
<li><em>habitat</em> gives the main habitat association for the species (i.e., farmland or forest)</li>
</ul>
<p>We might be interested to first get an aggregated summary of the data. For instance, let us look for each species at the total number of observations, that is, summed over all routes and over all years. To do this, we construct a <code>data.frame</code> to hold information at the species-level. We do this in two steps. First, we simplify the data frame <code>birds</code> so that it only contains two columns, <code>species</code> and <code>habitat</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>species.data <span class="ot">&lt;-</span> <span class="fu">unique</span>(birds[ , <span class="fu">c</span>(<span class="st">&quot;species&quot;</span>, <span class="st">&quot;habitat&quot;</span>)])</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>species.data</span></code></pre></div>
<p>Notice, that this data frame lists first all farmland species and then all forest species. Second, to this simpliefied data frame, we want to add the total number of observations for each species. We use the <code>tapply</code> function to sum the counts of each species.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sum counts for each species (over all years)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>total.counts <span class="ot">&lt;-</span> <span class="fu">tapply</span>(birds<span class="sc">$</span>organismQuantity, birds<span class="sc">$</span>species, sum)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>total.counts</span></code></pre></div>
<p><strong><em>Warning!</em></strong> Notice that the <code>total.counts</code> vector is in alphabetical order (this is the default behavior for <code>tapply</code> output). But the <code>species.data</code> data frame is sorted by habitat affiliation. Thus, before we can add to total counts to the new data frame <code>species.data</code>, we have to change to order of the entries in <code>total.counts</code> to match the order of the species in <code>species.data</code>. We can do this using the <code>match</code> function.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We add a new column to the data frame `species.data` containing the total counts in the correct order</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>species.data<span class="sc">$</span>total.count <span class="ot">&lt;-</span> total.counts[<span class="fu">match</span>(species.data<span class="sc">$</span>species, <span class="fu">names</span>(total.counts))]</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>species.data</span></code></pre></div>
<pre><code>##                          species habitat total.count
## 2                Alauda arvensis   Farms       30002
## 3               Anthus pratensis   Farms       31141
## 5            Emberiza citrinella   Farms       34165
## 8               Sturnus vulgaris   Farms       57801
## 9                Sylvia communis   Farms       18044
## 19             Falco tinnunculus   Farms        1009
## 20               Passer montanus   Farms       13302
## 25             Vanellus vanellus   Farms       14325
## 37              Saxicola rubetra   Farms       12850
## 58               Motacilla flava   Farms       14669
## 1                Accipiter nisus   Woods         536
## 4               Anthus trivialis   Woods       98580
## 6        Phoenicurus phoenicurus   Woods       36095
## 7                  Spinus spinus   Woods       84538
## 11             Dendrocopos major   Woods       21318
## 12           Garrulus glandarius   Woods        9040
## 13                Periparus ater   Woods        9948
## 43 Coccothraustes coccothraustes   Woods        1396
## 96             Pyrrhula pyrrhula   Woods        6234
## 99        Phylloscopus collybita   Woods       13296</code></pre>
<p>Convince yourself that this produces the desired result. Let us visualize the total counts in a bar plot where the species are ordered by habitat affiliation.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a vector of colors for plotting</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>species.data<span class="sc">$</span>col <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(species.data<span class="sc">$</span>habitat <span class="sc">%in%</span> <span class="st">&quot;Farms&quot;</span>, <span class="st">&quot;darkorange3&quot;</span>, <span class="st">&quot;forestgreen&quot;</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Set figure margins for plotting</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">7</span>,<span class="dv">4</span>,<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a bar plot of total counts per species</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="fu">barplot</span>(species.data<span class="sc">$</span>total.count<span class="sc">/</span><span class="dv">1000</span>, </span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">names.arg=</span>species.data<span class="sc">$</span>species,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">las=</span><span class="dv">2</span>, <span class="at">col=</span>species.data<span class="sc">$</span>col, </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">ylab=</span><span class="st">&quot;Total observations (x 1000)&quot;</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">cex.names=</span><span class="fl">0.5</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a legend to the plot</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topleft&quot;</span>, <span class="at">legend=</span><span class="fu">c</span>(<span class="st">&quot;Farmland&quot;</span>,<span class="st">&quot;Forest&quot;</span>), </span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch=</span><span class="dv">22</span>, <span class="at">pt.bg=</span><span class="fu">c</span>(<span class="st">&quot;darkorange3&quot;</span>, <span class="st">&quot;forestgreen&quot;</span>),</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">bty=</span><span class="st">&quot;n&quot;</span>, <span class="at">pt.cex=</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="Bird_survey_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p><span style="color: purple;"> <strong>Question 1</strong>: Please write down two conclusions you can make from this figure. </span></p>
<!---
Next, we plot for each species the change in counts through time. To do so, we will use a programming tool called a `for loop`. *For loops* are iterative operations that loop over a program by using an index. If you are unfamiliar with *for loops* you can find a brief introduction [here](https://clausrueffler.github.io/CodingWithR/Scripting.html). It is probably easiest to digest with a simple example.

In the code below, the first line starts the `for loop` and says to use the index "year" for values 2010 through 2015. Everything inside the curly brackets `{ }` will be executed as the index, "year", iterates through the specified range of values. In this example, we ask R to print a phrase about which year it is. A pause of 0.5 seconds is included so that you can watch the iteration happening.


```r
for (year in 2010:2015){
  print(paste("The year is", year))
  Sys.sleep(0.5)
  }
```
That was a trivial example but hopefully you get the general idea. Let us try using a more complex *for loop* to plot the temporal trends for each bird species in our data set.
--->
</div>
<div id="time-series-plots" class="section level3">
<h3>Time series plots</h3>
<p>Next, we plot for each species the change in counts through time. In order to do this we start by creating a new data frame in which we store the for each species and for each year the total count summed over all routes. We can do this using the <code>tapply</code>-function but now with respect to two factors, namely, species and year.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>count.per.year <span class="ot">&lt;-</span> <span class="fu">tapply</span>(birds<span class="sc">$</span>organismQuantity, <span class="fu">list</span>(birds<span class="sc">$</span>year, birds<span class="sc">$</span>species), sum)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Convince yourself that this gives the desired result.</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(count.per.year, <span class="dv">3</span>)</span></code></pre></div>
<p>Note, that again these counts are arranged alphabetically with respect to species names. We can use the same trick as above to rearrange the order so as to match the original order we use in the data frame <code>species.data</code>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>count.per.year <span class="ot">&lt;-</span> count.per.year[ , <span class="fu">c</span>(<span class="fu">match</span>(species.data<span class="sc">$</span>species, <span class="fu">names</span>(total.counts)))]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Let us inspect whether the data look as intended.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(count.per.year, <span class="dv">3</span>)</span></code></pre></div>
<p>Now we are ready to plot for each species the time series. To do so, we use a programming tool called a <code>for loop</code>. <em>For loops</em> are iterative operations that loop over a program by using an index. If you are unfamiliar with <em>for loops</em> you can find a brief introduction <a href="https://clausrueffler.github.io/CodingWithR/Scripting.html">here</a>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First set the layout and margins of the figure</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">4</span>), <span class="at">mar=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="fl">1.5</span>,<span class="dv">1</span>), <span class="at">oma=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">4</span>,<span class="dv">0</span>,<span class="dv">4</span>))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(count.per.year)){<span class="co"># this for-loop iteratively produces the plot for the different species by cycling through the columns of the data frame `count.per.year`.</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="dv">1998</span><span class="sc">:</span><span class="dv">2021</span>, count.per.year[ , i], </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;Total Obs.&quot;</span>, <span class="at">xlab=</span><span class="cn">NA</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">ifelse</span>(i <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="st">&quot;darkorange3&quot;</span>, <span class="st">&quot;forestgreen&quot;</span>), </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd=</span><span class="dv">3</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Last, add a title at the top of the panel with the name of the species</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtext</span>(<span class="fu">unique</span>(birds<span class="sc">$</span>species)[i], <span class="dv">3</span>, <span class="dv">0</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">font=</span><span class="dv">2</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="Bird_survey_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<!---

```r
# Bob's original code
# First set the layout and margins of the figure
par(mfcol=c(5,4), mar=c(2,4,1.5,1), oma=c(0,4,0,4))

# Now we will use a `for loop` to cycle through each species.
# The first line says to use the index "i" for 1 through the 
# total number of bird species (20 in our case).
for (i in 1:length(unique(birds$species))){
# Next we subset the data corresponding to the i-th species
  focal_data <- birds[birds$species %in% unique(birds$species)[i],]
# Next we compute the counts per year for the i-th species
  trend <- tapply(focal_data$organismQuantity, focal_data$year, sum)  
# Now we plot the trend through time for the i-th species
  plot(names(trend), trend,
       type="l", ylab="Total Obs.", xlab=NA,
       col=ifelse("Farms" %in% focal_data$habitat, "darkorange3", "forestgreen"), 
       lwd=3)
# Last, add a title at the top of the panel with the name of the species
  mtext(unique(birds$species)[i], 3, 0, cex=0.5, font=2)
}
```

<img src="Bird_survey_files/figure-html/unnamed-chunk-11-1.png" width="672" />
--->
<p>Ok…what’s going on? Are you surprised to see that the trends for all species appear to be increasing? Are birds really taking over Sweden?!? No, unfortunately not…</p>
<p>The general increase in total observations per species is at least partly due to the fact that the Swedish Bird Inventory added new survey routes during the first years so that the number of routes sampled per year is increasing. This is problematic for making valid comparisons between years because we are obviously likely to count more birds when we survey more routes (<em>think back to our lecture on</em> <strong><em>rarefaction</em></strong>).</p>
<p>Now let us try and correct for the different number of routes sampled per year by computing the number of counts per species per year <em>per survey route</em>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the number of routes recorded for each year</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>nroutes <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">table</span>(birds<span class="sc">$</span>LocationID, birds<span class="sc">$</span>year) <span class="sc">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s redo the figure by dividing the number of observations </span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># per species per year by the number of routes surveyed each year.</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co"># First set the layout and margins of the figure.</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">4</span>), <span class="at">mar=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="fl">1.5</span>,<span class="dv">1</span>), <span class="at">oma=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">4</span>,<span class="dv">0</span>,<span class="dv">4</span>))</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(count.per.year)){</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="dv">1998</span><span class="sc">:</span><span class="dv">2021</span>, count.per.year[ , i]<span class="sc">/</span>nroutes, </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;Total Obs.&quot;</span>, <span class="at">xlab=</span><span class="cn">NA</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">ifelse</span>(i <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="st">&quot;darkorange3&quot;</span>, <span class="st">&quot;forestgreen&quot;</span>), </span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd=</span><span class="dv">3</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Last, add a title at the top of the panel with the name of the species</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtext</span>(<span class="fu">unique</span>(birds<span class="sc">$</span>species)[i], <span class="dv">3</span>, <span class="dv">0</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">font=</span><span class="dv">2</span>)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<!---

```r
# Bob's original code
# Compute the number of routes recorded for each year
nroutes <- colSums(table(birds$LocationID, birds$year) > 0)

# Let's redo the figure by dividing the number of observations 
# per species per year by the number of routes surveyed each year
par(mfcol=c(5,4), mar=c(2,4,1.5,1), oma=c(0,4,0,4))

for (i in 1:length(unique(birds$species))){
  focal_data <- birds[birds$species %in% unique(birds$species)[i],]
  # Plot a panel for each species (note that we now divide by 'nroutes')
  plot(sort(unique(focal_data$year)),
  tapply(focal_data$organismQuantity, focal_data$year, sum)/nroutes, 
       type="l", ylab="Obs. per route", xlab=NA, lwd=3,
       col=ifelse("Farms" %in% focal_data$habitat, "darkorange3", "forestgreen"))
  mtext(unique(birds$species)[i], 3, 0, cex=0.5, font=2)
}
```

<img src="Bird_survey_files/figure-html/unnamed-chunk-13-1.png" width="672" />
--->
<p><span style="color: purple;"> <strong>Question 2</strong>: After correcting for number of routes sampled per year, which species appears to have the most obvious increase in abundance over the survey period? Which species appears to have the most obvious decrease in abundance over the survey period? Can you detect a general trend among farmland and forest species? </span></p>
<p>For times series like these it is common to report the data as an index relative to the count of the first year. Given the code that we have, it is easy to implement this change. All that we have to do is to divide the average number of individuals per route by the result for the first year. Let us have a look at the time series for the Skylark <em>Alauda arvensis</em>.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Time series for the average number of Skylarks per standard route for each year.</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>count.per.year[ , <span class="dv">1</span>]<span class="sc">/</span>nroutes</span></code></pre></div>
<p>The same time series but with all data divided by the result from the first year. Note. that now the count for the first year equals 1.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>(count.per.year[ , <span class="dv">1</span>]<span class="sc">/</span>nroutes)<span class="sc">/</span>(count.per.year[<span class="dv">1</span> , <span class="dv">1</span>]<span class="sc">/</span>nroutes[<span class="dv">1</span>])</span></code></pre></div>
<p>With this small modification. our time series plots can be computed as follows.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfcol=</span><span class="fu">c</span>(<span class="dv">5</span>,<span class="dv">4</span>), <span class="at">mar=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>,<span class="fl">1.5</span>,<span class="dv">1</span>), <span class="at">oma=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">4</span>,<span class="dv">0</span>,<span class="dv">4</span>))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(count.per.year)){</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="dv">1998</span><span class="sc">:</span><span class="dv">2021</span>, (count.per.year[ , i]<span class="sc">/</span>nroutes)<span class="sc">/</span>(count.per.year[<span class="dv">1</span> , i]<span class="sc">/</span>nroutes[<span class="dv">1</span>]),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>       <span class="co"># for better comparison with the plots from Svensk Fågeltaxering we change the y-axis so that it starts at zero and is exactly as long as needed </span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>((count.per.year[ , i]<span class="sc">/</span>nroutes)<span class="sc">/</span>(count.per.year[<span class="dv">1</span> , i]<span class="sc">/</span>nroutes[<span class="dv">1</span>])<span class="sc">+</span><span class="fl">0.3</span>)), <span class="at">yaxs=</span><span class="st">&quot;i&quot;</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">ylab=</span><span class="st">&quot;Total Obs.&quot;</span>, <span class="at">xlab=</span><span class="cn">NA</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">col=</span><span class="fu">ifelse</span>(i <span class="sc">%in%</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="st">&quot;darkorange3&quot;</span>, <span class="st">&quot;forestgreen&quot;</span>), </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd=</span><span class="dv">3</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mtext</span>(<span class="fu">unique</span>(birds<span class="sc">$</span>species)[i], <span class="dv">3</span>, <span class="dv">0</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">font=</span><span class="dv">2</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><span style="color: purple;"> <strong>Question 3</strong>: Let us compare our plots with those produced by Svensk Fågeltaxering. You can find the official time series plot from Svensk Fågeltaxering <a href="https://www.fageltaxering.lu.se/resultat/trender/trender-standardrutterna">here</a>. What do you conclude? </span></p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
